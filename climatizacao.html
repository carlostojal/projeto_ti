<!doctype html>
<html lang="pt-PT">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="bootstrap.min.css" crossorigin="anonymous">

    <title>Climatização</title>
  </head>
  <body>
    <script src="./script.js"></script>
    <div class="container-fluid">
      <p><b>Velocidade da ventilação</b></p>
      <div class="card text-white bg-light mb-3" style="max-width: 18rem; align-self: center;">
          <button class="btn btn-lg btn-outline-dark" onclick="onincrement()">+</button>
          <div class="card-body">
              <p class="card-text bg-dark" style="font-size: 40px; align-content: center;" id="fan_speed">10</p>
          </div>
          <button class="btn btn-lg btn-outline-dark" onclick="ondecrement()">-</button>
      </div>
      <div>
        <label for="temperatura" class="form-label" id="label_temperatura">Temperatura</label>
        <input type="range" onchange="(e) => on_temp_change(e)" class="form-range" min="10" max="35" id="temperatura">
      </div>
      <br>
      <p id="outside_temp">Temperatura exterior: ...ºC</p>
      <p id="rain">Chuva: ...</p>
      <p id="ambient_light">Luz ambiente: ...</p>
    </div>
    <script>

      let config = {};

      let inside_temp = null, outside_temp = null, humidity = null, ambient_light = null;
      let windshield_wiper = null, headlights = null;
      let ac_temp = null, ac_fan_speed = null;
  
      let temperatura_element = document.getElementById("temperatura");
      let fan_speed_element = document.getElementById("fan_speed");
      let label_temperatura = document.getElementById("label_temperatura");
  
      temperatura_element.addEventListener("change", (e) => {
        on_temp_change(e.target.value);
      })
  
      async function render() {
  
        let label_temperatura_exterior = document.getElementById("outside_temp");
        let label_rain = document.getElementById("rain");
        let label_ambient_light = document.getElementById("ambient_light");
  
        let sensors = await get_sensor_data();
  
        sensors.forEach((sensor) => {
          console.log(sensor);

          if(sensor.name == "ac_temp")
            ac_temp = sensor.value;
          else if(sensor.name == "ac_fan_speed")
            ac_fan_speed = sensor.value;
          else if(sensor.name == "outside_temp")
            outside_temp = sensor.value;
          else if(sensor.name == "inside_temp")
            inside_temp = sensor.value;
          else if(sensor.name == "rain")
            humidity = sensor.value;
          else if(sensor.name == "ambient_light")
            ambient_light = sensor.value == 1;
          else if(sensor.name == "headlights")
            headlights = sensor.value == 1;
          else if(sensor.name == "windshield_wiper")
            windshield_wiper = sensor.value == 1;

          temperatura_element.value = ac_temp;
          fan_speed_element.innerHTML = ac_fan_speed;
          label_temperatura.innerHTML = "<b>Temperatura:</b> " + ac_temp + "ºC";

          label_temperatura_exterior.innerHTML = `<b>Temperatura exterior:</b> ${outside_temp ? outside_temp.toFixed(2) : "..."}ºC`;
          label_rain.innerHTML = `<b>Humidade:</b> ${humidity ? (humidity * 100).toFixed(2): "..."}% (Escovas ${windshield_wiper ? "ligadas" : "desligadas"})`;
          label_ambient_light.innerHTML = `<b>Luz ambiente:</b> ${ambient_light ? 'Sim' : 'Não'} (luzes ${headlights ? "ligadas" : "desligadas"})`;

        });
      }
  
      render();
      setInterval(render, 2500);
  
      function on_temp_change(value) {
        label_temperatura.innerHTML = "<b>Temperatura:</b> " + value + "ºC";
        update_temp(value);
      }
  
      function onincrement() {
        ac_fan_speed++;
        fan_speed_element.innerHTML = ac_fan_speed;
        update_fan_speed(ac_fan_speed);
      }
  
      function ondecrement() {
        ac_fan_speed--;
        fan_speed_element.innerHTML = ac_fan_speed;
        update_fan_speed(ac_fan_speed);
      }
    </script>
  </body>
</html>